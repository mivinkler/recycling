{% extends 'base.html' %}
{% load static %}

{% block title %}Zerlegung auswählen{% endblock %}

{% block content %}
<div class="itemcard">
  <section class="itemcard-title">
    <h2>Zerlegung erstellen</h2>
    <div>
      <input
        type="text"
        id="barcode"
        placeholder="Barcode scannen..."
        autocomplete="off"
        data-accepted="S"
        data-api="{% url 'barcode_recycling_api' %}"
        data-create-url="{% url 'recycling_create' %}"
        autofocus
        class="visually-hidden-input"
      />

      <label for="barcode" class="barcode-wrapper header-menu-icon svg-icon" id="barcode-label">
        <img src="{% static 'icons/barcode-scan-active.svg' %}" id="barcode-active">
        <img src="{% static 'icons/barcode-scan-inactive.svg' %}" id="barcode-inactive" hidden>
      </label>
    </div>
  </section>

  {# ============= Vorsortierung-Wagen zufügen ============= #}
  <section class="itemcard-topbox">
    <h4>Vorsortierung-Wagen zufügen:</h4>
    <table class="itemcard-table">
      <thead class="itemcard-thead">
        <tr>
          <th class="itemcard-id">№</th>
          <th class="itemcard-id">VID</th>
          <th class="itemcard-material">Material</th>
          <th class="itemcard-boxtype">Behälter</th>
          <th class="itemcard-status">Status</th>
          <th class="itemcard-weight">Gewicht</th>
          <th class="itemcard-note">Anmerkung</th>
          <th class="itemcard-action"></th>
        </tr>
      </thead>

      <tbody class="itemcard-tbody">
        {% for u_ready in unloads_ready %}
        <tr class="itemcard-table-row">
          <td class="itemcard-id"><p>{{ forloop.counter }}</p></td>
          <td class="itemcard-id"><p>{{ u_ready.id }}</p></td>
          <td class="itemcard-material"><p>{{ u_ready.material }}</p></td>
          <td class="itemcard-boxtype"><p>{{ u_ready.get_box_type_display }}</p></td>
          <td class="itemcard-material"><p>{{ u_ready.get_status_display }}</p></td>
          <td class="itemcard-weight"><p>{{ u_ready.weight }}</p></td>
          <td class="itemcard-note"><p>{{ u_ready.note }}</p></td>

          <td class="itemcard-action-wrapper">
            <div class="itemcard-action">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="unload_id" value="{{ u_ready.pk }}">
                <button type="submit" class="btn btn-lock">
                  Zufügen
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  {# ============= Aktiv in Zerlegung ============= #}
  <section name="recycling">
    <h4>Aktiv in Zerlegung</h4>

    {# FORM für UPDATE nur öffnen, wenn edit_recycling vorhanden ist #}
    {% if edit_recycling %}
      <form method="post" action="{% url 'recycling_update' recycling_pk=edit_recycling.pk %}">
        {% csrf_token %}
    {% endif %}

    <table class="itemcard-table">
      <thead class="itemcard-thead">
        <tr>
          <th class="itemcard-id">№</th>
          <th class="itemcard-id">ID</th>
          <th class="itemcard-material">Material</th>
          <th class="itemcard-boxtype">Behälter</th>
          <th class="itemcard-status">Status</th>
          <th class="itemcard-note">Anmerkung</th>
          <th class="itemcard-weight">Gewicht</th>
          <th class="itemcard-weight">Gewicht neu</th>
          <th class="itemcard-action"></th>
        </tr>
      </thead>

      <tbody class="itemcard-tbody">
        {% for recycling in recyclings %}
          {% if edit_recycling and recycling.pk == edit_recycling.pk %}
            <tr class="itemcard-table-row">
              <td class="itemcard-id">
                <a href="{% url 'recycling_delete' recycling_pk=recycling.pk %}" class="btn btn-lock" title="Löschen">
                  <img src="{% static 'icons/delete-icon.svg' %}" alt="">
                </a>
              </td>
              <td class="itemcard-id"><p>{{ recycling.id }}</p></td>
              <td class="itemcard-material">{{ form.material }}</td>
              <td class="itemcard-boxtype">{{ form.box_type }}</td>
              <td class="itemcard-status">{{ form.status }}</td>
              <td class="itemcard-note">{{ form.note }}</td>
              <td class="itemcard-weight"><p>{{ recycling.weight }}</p></td>
              <td class="itemcard-weight">
                <input
                  type="number"
                  step="0.01"
                  name="new_weight"
                  class="active-border"
                  value=""
                  placeholder=""
                >
              </td>
              <td class="itemcard-action">
                <a href="{% url 'recycling_create' %}" class="btn btn-lock">
                  <img src="{% static 'icons/lock-open-icon.svg' %}">
                </a>
                <button type="submit" class="btn btn-main">Speichern</button>
              </td>
            </tr>
          {% else %}
            <tr class="itemcard-table-row">
              <td class="itemcard-id"><p>{{ forloop.counter }}</p></td>
              <td class="itemcard-id"><p>{{ recycling.id }}</p></td>
              <td class="itemcard-material"><p>{{ recycling.material }}</p></td>
              <td class="itemcard-boxtype"><p>{{ recycling.get_box_type_display }}</p></td>
              <td class="itemcard-status"><p>{{ recycling.get_status_display }}</p></td>
              <td class="itemcard-note"><p>{{ recycling.note }}</p></td>
              <td class="itemcard-weight"><p>{{ recycling.weight }}</p></td>
              <td class="itemcard-weight"><p></p></td>
              <td class="itemcard-action">
                <a href="{% url 'recycling_update' recycling_pk=recycling.pk %}" class="btn btn-lock">
                  <img src="{% static 'icons/lock-icon.svg' %}">
                </a>
              </td>
            </tr>
          {% endif %}
        {% endfor %}

        {% if form and form.errors %}
          <tr class="itemcard-table-row">
            <td colspan="9">{{ form.errors }}</td>
          </tr>
        {% endif %}

        {# ============= CREATE NEW ROW ============= #}
        <form method="post" action="{% url 'recycling_create' %}">
          {% csrf_token %}
          <tr class="itemcard-table-row">
            <td class="itemcard-id"></td>
            <td class="itemcard-id"></td>
            <td class="itemcard-material">{{ new_form.material }}</td>
            <td class="itemcard-boxtype">{{ new_form.box_type }}</td>
            <td class="itemcard-status">{{ new_form.status }}</td>
            <td class="itemcard-note">{{ new_form.note }}</td>
            <td class="itemcard-weight">{{ new_form.weight }}</td>
            <td class="itemcard-weight"></td>

            <td class="itemcard-action">
              {% if edit_recycling %}
                 <a href="{% url 'recycling_create' %}" class="btn btn-lock">
                  <img src="{% static 'icons/lock-icon.svg' %}">
                </a>
              {% else %}
                <button type="button" class="btn btn-lock" title="Neue Fraktion">
                  <img src="{% static 'icons/lock-open-icon.svg' %}" alt="">
                </button>
                <button type="submit" class="btn btn-main">Speichern</button>
              {% endif %}
            </td>
          </tr>
        </form>

        {% if new_form and new_form.errors %}
          <tr class="itemcard-table-row">
            <td colspan="9">{{ new_form.errors }}</td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    {% if edit_recycling %}
      </form>
    {% endif %}
  </section>
</div>

<script src="{% static 'js/barcode/barcode-recycling.js' %}" defer></script>
{% endblock %}