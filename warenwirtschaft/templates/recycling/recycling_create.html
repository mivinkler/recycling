{# templates/recycling/recycling_update.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}Zerlegung{% endblock %}

{% block content %}
<form method="post">
  {% csrf_token %}

  <div class="itemcard">
    <div class="itemcard-title itemcard-margin-left">
      <h2>Zerlegung</h2>
    </div>

    <section class="itemcard-topbox itemcard-margin-left">
      <div class="itemcard-topbox-row">
        <h3>Vorsortierung-wagen: &emsp; {{ unload }}</h3>
      </div>
    </section>

    <section class="itemcard-topbox">
      <h4 class="itemcard-margin-left">Zerlegung-Fraktionen:</h4>

      <table class="itemcard-table">
        <thead class="itemcard-thead">
          <tr>
            <th class="checkbox-circle itemcard-action-left"></th>
            <th class="itemcard-id">№</th>
            <th class="itemcard-id">ID</th>
            <th class="itemcard-material">Material</th>
            <th class="itemcard-boxtype">Behälter</th>
            <th class="itemcard-weight">Gewicht</th>
            <th class="itemcard-note">Anmerkung</th>
            <th class="itemcard-action"></th>
          </tr>
        </thead>

        <tbody class="itemcard-tbody">
          {% for item in all_recyclings %}
            <tr class="itemcard-table-row">
              <td class="checkbox-circle itemcard-action-left">
                <input
                  type="checkbox"
                  name="recycling_ids"
                  value="{{ item.pk }}"
                  data-checkbox="{{ item.pk }}"
                  {% if item.pk in active_recycling_ids %}checked{% endif %}
                >
              </td>

              <td class="itemcard-id">{{ forloop.counter }}</td>
              <td class="itemcard-id">{{ item.pk }}</td>
              <td class="itemcard-material"><p>{{ item.material }}</p></td>
              <td class="itemcard-boxtype"><p>{{ item.get_box_type_display }}</p></td>
              <td class="itemcard-weight"><p>{{ item.weight }}</p></td>
              <td class="itemcard-note"><p>{{ item.note }}</p></td>

              <td class="itemcard-action-wrapper">
                <div class="itemcard-action">
                  <button
                    type="button"
                    class="btn btn-lock"
                    title="Verbinden (Checkbox aktivieren)"
                    data-toggle="{{ item.pk }}"
                  >
                    <img src="{% static 'icons/link-hyperlink-icon.svg' %}" alt="">
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}

          {# ===== NEUE ZEILE ===== #}
          <tr class="itemcard-table-row">
            <td class="checkbox-circle itemcard-action-left"></td>
            <td class="itemcard-id"></td>
            <td class="itemcard-id">neu</td>
            <td class="itemcard-material">{{ new_form.material }}</td>
            <td class="itemcard-boxtype">{{ new_form.box_type }}</td>
            <td class="itemcard-weight">{{ new_form.weight }}</td>
            <td class="itemcard-note">{{ new_form.note }}</td>
            <td class="itemcard-action-wrapper"></td>
          </tr>
        </tbody>
      </table>

      {% if new_form.errors %}
        <div class="itemcard-margin-left">
          {{ new_form.errors }}
        </div>
      {% endif %}

      <div class="itemcard-margin-left" style="margin-top: 12px;">
        <button type="submit" class="btn btn-main btn-save">Speichern</button>
      </div>
    </section>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("click", function (e) {
    const btn = e.target.closest("[data-toggle]");
    if (!btn) return;

    const id = btn.dataset.toggle;
    const checkbox = document.querySelector('[data-checkbox="' + id + '"]');
    if (!checkbox) return;

    checkbox.checked = !checkbox.checked;
  });
</script>
{% endblock %}