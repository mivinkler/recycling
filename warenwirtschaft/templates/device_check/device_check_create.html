{% extends "base.html" %}
{% load static %}

{% block title %}Geräteprüfung{% endblock %}

{% block content %}
<form method="post" class="add-row-js" id="device-check-form">
  {% csrf_token %}
  <input type="hidden" name="action" id="form-action" value="">

  <div class="itemcard">
    <div class="itemcard-title">
      <h2>Halle 2 – Geräteprüfung</h2>
    </div>

  <section class="itemcard-topbox">
    <div class="itemcard-topbox-row">
      <span>Wagen:</span>
      <p>{{ source_obj }}</p>

      <button
        type="button"
        class="btn btn-main itemcard-topbox-btn"
        id="finish-device-check-btn"
      >
        Leerung abschließen
      </button>
    </div>
  </section>

    <table class="itemcard-table">
      {{ formset.management_form }}

      <thead>
        <tr>
          <th>№</th>
          <th>Behälter</th>
          <th>Material</th>
          <th>Zweck</th>
          <th>Gewicht</th>
          <th>Anmerkung</th>
          <th class="itemcard-row-delete">
            <img src="{% static 'icons/delete-icon.svg' %}" title="Zeile löschen">
          </th>
        </tr>
      </thead>

      <tbody data-formset-body data-formset-prefix="{{ formset.prefix }}">
        {% for f in formset %}
          <tr data-formset-row>
            {{ f.id }}
            <td data-formset-index>{{ forloop.counter }}</td>
            <td>{{ f.box_type }}</td>
            <td>{{ f.material }}</td>
            <td>{{ f.purpose }}</td>
            <td>{{ f.weight }}</td>
            <td>{{ f.note }}</td>
            <td class="itemcard-row-delete">
              <label class="checkbox-square">
                {{ f.DELETE }}
                <span data-name="cross"></span>
              </label>
            </td>
          </tr>
        {% endfor %}
      </tbody>

      <template data-formset-template>
        <tr data-formset-row>
          <td data-formset-index>__index__</td>
          <td>{{ formset.empty_form.box_type }}</td>
          <td>{{ formset.empty_form.material }}</td>
          <td>{{ formset.empty_form.purpose }}</td>
          <td>{{ formset.empty_form.weight }}</td>
          <td>{{ formset.empty_form.note }}</td>
          <td class="itemcard-row-delete">
            <label class="checkbox-square">
              {{ formset.empty_form.DELETE }}
              <span data-name="cross"></span>
            </label>
          </td>
        </tr>
      </template>
    </table>


    <div class="itemcard-action">
      <button type="button" data-formset-add class="btn btn-row-add">+</button>
      <button type="button" data-formset-remove class="btn btn-row-add">–</button>
    </div>

    <div class="buttons-form-footer">
      <a href="{% url 'device_check_select' %}" class="btn  btn-main">Zurück</a>
      <button type="submit" class="btn btn-main">Speichern</button>
    </div>
  </div>

  <!-- Confirm modal -->
  <div id="confirm-overlay" class="cm-overlay" hidden>
    <div class="cm-modal" role="dialog" aria-modal="true">
      <h3 class="cm-title">Geräteprüfung abschließen</h3>
      <p class="cm-text">
        Sind Sie sicher, dass der Wagen als <b>abholbereit</b> markiert werden soll?
      </p>
  
      <div class="cm-actions">
        <button type="button" class="btn btn-main" id="cm-yes">Ja</button>
        <button type="button" class="btn btn-main" id="cm-no">Nein</button>
      </div>
    </div>
  </div>
</form>

{% endblock %}

<style>
  .cm-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35);
    z-index:10000; display:flex; align-items:center; justify-content:center; padding:16px; }
  .cm-overlay[hidden]{ display:none !important; }
  .cm-modal{ width:min(520px,100%); background:#fff; border-radius:10px;
    padding:20px 22px; box-shadow:0 12px 34px rgba(0,0,0,.25); }
  .cm-title{ margin:0 0 10px; font-size:1.25rem; }
  .cm-text{ margin:0 0 16px; line-height:1.4; }
  .cm-actions{ display:flex; gap:10px; justify-content:flex-end; }
</style>

{% block extra_js %}
<script src="{% static 'js/add-table-row.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const openBtn = document.getElementById('finish-device-check-btn');
  const overlay = document.getElementById('confirm-overlay');
  const yesBtn = document.getElementById('cm-yes');
  const noBtn = document.getElementById('cm-no');
  const form = document.getElementById('device-check-form');
  const actionInput = document.getElementById('form-action');

  const open = () => overlay.hidden = false;
  const close = () => {
    overlay.hidden = true;
    actionInput.value = "";
  };

  openBtn.addEventListener('click', open);
  noBtn.addEventListener('click', close);

  yesBtn.addEventListener('click', () => {
    actionInput.value = "finish_device_check";
    form.submit();
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) close();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !overlay.hidden) close();
  });
});
</script>
{% endblock %}

