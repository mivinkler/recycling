{% extends 'base.html' %}
{% load static %}

{% block title %}Vorsortierung erfassen{% endblock %}

{% block content %}
<form method="post" action="" id="unload-form">
  {% csrf_token %}

  <div class="itemcard">
    <div class="itemcard-title itemcard-margin-left">
      <h2>Vorsortierung erstellen</h2>
    </div>

    {# ======  Head  ======= #}

    <section class="itemcard-topbox itemcard-margin-left">
      {{ form.delivery_units.errors }}
      {{ form.non_field_errors }}

      <div class="itemcard-topbox-row">
        <label for="barcode">Barcode:</label>
        <div>
          <input type="text" id="barcode" name="barcode" autofocus autocomplete="off" placeholder="Scannen..." />
        </div>
      </div>

      <div class="itemcard-topbox-row">
        {# DE: Label korrekt mit dem Feld verknüpfen #}
        <label for="{{ form.delivery_unit.id_for_label }}">Liefereinheiten:</label>
        <div>{{ form.delivery_unit }}</div>
      </div>
    </section>

    {# ====== Neue Unloads ====== #}

    <section class="itemcard-topbox">
      <div class="itemcard-table-title itemcard-margin-left">Neue Wagen:</div>

      <table class="itemcard-table">
        {{ formset.management_form }}
        
        <thead class="itemcard-thead">
          <tr>       
            <th class="checkbox-circle itemcard-action-left"></th>
            <th class="itemcard-id">№</th>
            <th class="itemcard-material">Material</th>
            <th class="itemcard-boxtype">Behälter</th>
            <th class="itemcard-status">Status</th>
            <th class="itemcard-weight">Gewicht</th>
            <th class="itemcard-action-alone"></th>
          </tr>
        </thead>
        
        <tbody class="itemcard-tbody">
          {{ formset.non_form_errors }}

          {% for f in formset.forms %}
          <tr>
            <td class="checkbox-circle itemcard-action-left">
              <input type="radio" style="visibility: hidden;">
            </td>
            <td class="itemcard-id">{{ forloop.counter }}</td>
            <td class="itemcard-material">{{ f.material }}</td>
            <td class="itemcard-boxtype">{{ f.box_type }}</td>
            <td class="itemcard-status">{{ f.status }}</td>
            <td class="itemcard-weight">{{ f.weight }}</td>
            <td class="itemcard-action-wrapper">
              <div class="itemcard-action">
                <div class="btn btn-lock">
                  <img src="{% static 'icons/dashboard-icon.svg' %}">
                </div>
                <button type="submit" class="btn btn-main">Speichern</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    {# ====== Vorhandene Wagen ====== #}

    <section>
      <div class="itemcard-table-title itemcard-margin-left">Vorhandene Wagen:</div>

      {{ existing_formset.management_form }}
      <table class="itemcard-table">
        <thead class="itemcard-thead">
          <tr>
            <th class="checkbox-circle itemcard-action-left"></th>
            <th class="itemcard-id">№</th>
            <th class="itemcard-material">Material</th>
            <th class="itemcard-boxtype">Behälter</th>
            <th class="itemcard-status">Status</th>
            <th class="itemcard-weight">Gewicht</th>
            <th class="itemcard-action"></th>
          </tr>
        </thead>

        <tbody class="itemcard-tbody existing-tbody">
          {% for form in existing_formset.forms %}
            {% with u=form.instance %}
            <tr class="itemcard-table-row" data-id="{{ u.pk }}">

              <td class="checkbox-circle itemcard-action-left">
                <input type="radio" name="selected_recycling" value="{{ u.pk }}" title="Fraktion verknüpfen">
              </td>
              <td class="itemcard-id">{{ forloop.counter }}</td>
              <td class="itemcard-material"><p>{{ u.material }}</p></td>
              <td class="itemcard-boxtype"><p>{{ u.box_type }}</p></td>

              <td class="itemcard-status">
                {{ form.id }}
                {{ form.status }}
              </td>

              <td class="itemcard-weight itemcard-weight-action">
                <div class="flex-container">
                  {{ form.weight }}
                  <button type="button" class="btn btn-weight">
                    <img src="{% static 'icons/dashboard-icon.svg' %}">
                  </button>
                </div>
              </td>


              <td class="itemcard-action-wrapper">
                <div class="itemcard-action state-locked">
                  <div class="btn btn-lock">
                    <img src="{% static 'icons/lock-icon.svg' %}">
                  </div>
                </div>

                <div class="itemcard-action state-unlocked">
                  <div class="btn btn-lock">
                    <img src="{% static 'icons/lock-open-icon.svg' %}">
                  </div>
                  <button type="submit" class="btn btn-main">Speichern</button>
                </div>
              </td>
            </tr>
            {% endwith %}
          {% endfor %}
        </tbody>

      </table> 
    </section>
  </div>
</form>


  <style>

    .btn-weight {
      padding: 0 5px;
      height: 26px;
      border: none;
      border-left: 1px solid #ccc;
      border-radius: 0;
    }

    .flex-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }


    .itemcard-weight-action input {
      border: none;
      outline: none
    }


    .itemcard-action-wrapper {
      width: 114px;
      background-color: transparent;
      border: none;
    }

    .state-active {
      display: none;
    }




  /* offen standardmäßig verstecken */
  .itemcard-action-wrapper .state-unlocked { display: none !important; }

  /* wenn Zeile geöffnet, offen zeigen */
  .itemcard-table-row.is-open .itemcard-action-wrapper .state-locked { display: none !important; }
  .itemcard-table-row.is-open .itemcard-action-wrapper .state-unlocked { display: flex !important; }

  /* Eingaben in geschlossenen Zeilen blockieren */
  .itemcard-table-row:not(.is-open) input,
  .itemcard-table-row:not(.is-open) select,
  .itemcard-table-row:not(.is-open) textarea,
  .itemcard-table-row:not(.is-open) input[type="radio"],
  .itemcard-table-row:not(.is-open) input[type="checkbox"] {
    pointer-events: none;
    opacity: 0.6;
  }
  .itemcard-table-row.is-open input,
  .itemcard-table-row.is-open select,
  .itemcard-table-row.is-open textarea {
    pointer-events: auto;
    opacity: 1;
  }

  /* optional, nur für Cursor bei :disabled */
  .itemcard-table-row :disabled { cursor: not-allowed; }

</style>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/barcode-scan.js' %}"></script>
<script>
// Helfer zum (de-)aktivieren der Felder in einer Tabellenzeile
function setRowLockState(row, open) {
  // Nur sichtbare, bearbeitbare Felder anpacken (keine hidden inputs)
  const controls = row.querySelectorAll(
    'input:not([type="hidden"]), select, textarea, button.btn-weight'
  );

  controls.forEach(el => {
    // "disabled" und "readonly" je nach Zustand setzen
    if (open) {
      el.disabled = false;
      el.readOnly = false;
      el.setAttribute('aria-disabled', 'false');
    } else {
      el.disabled = true;
      el.readOnly = true;
      el.setAttribute('aria-disabled', 'true');
    }
  });
}

// Initial alle Zeilen schließen (außer если хочешь одну открытую по умолчанию)
function lockAllRows() {
  document.querySelectorAll('.itemcard-table-row').forEach(row => {
    row.classList.remove('is-open');
    setRowLockState(row, /*open=*/false);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  // Beim Laden alles закрыть
  lockAllRows();
});

// Akkordeon-Logik + (de)aktivieren Felder
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-lock');
  if (!btn) return;

  const row = btn.closest('.itemcard-table-row');
  if (!row) return;

  // Zuerst alle anderen Zeilen schließen
  document.querySelectorAll('.itemcard-table-row.is-open')
    .forEach(r => {
      if (r !== row) {
        r.classList.remove('is-open');
        setRowLockState(r, /*open=*/false);
      }
    });

  // Aktuelle Zeile umschalten
  const willOpen = !row.classList.contains('is-open');
  row.classList.toggle('is-open', willOpen);
  setRowLockState(row, /*open=*/willOpen);
});
</script>

{% endblock %}

