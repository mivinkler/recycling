{% extends 'base.html' %}
{% load static %}

{% block title %}Vorsortierung bearbeiten{% endblock %}

{% block content %}
<form method="post" action="" id="unload-form" data-mode="update">
  {% csrf_token %}

  <div class="itemcard">
    <div class="itemcard-title itemcard-margin-left">
      <h2>Vorsortierung bearbeiten</h2>
    </div>

    {# ====== Wareneingang ====== #}
    <section class="itemcard-topbox itemcard-margin-left">
      {{ form.delivery_units.errors }}
      {{ form.non_field_errors }}

      <div class="itemcard-topbox-row">
        <label for="barcode">Barcode:</label>
        <div>
          <input type="text" id="barcode" name="barcode" autofocus autocomplete="off" placeholder="Scannen..." />
        </div>
      </div>

      <div class="itemcard-topbox-row">
        <span>Wareneingang:</span>
        <div>{{ delivery_unit }}</div>
      </div>
    </section>

    {# ====== Neue Wagen ====== #}
    <section class="itemcard-topbox">
      <div class="itemcard-table-title itemcard-margin-left">Neue Wagen:</div>

      <table class="itemcard-table">
        {{ formset.management_form }}

        <thead class="itemcard-thead">
          <tr>
            <th class="checkbox-circle itemcard-action-left"></th>
            <th class="itemcard-id">â„–</th>
            <th class="itemcard-material">Material</th>
            <th class="itemcard-boxtype">BehÃ¤lter</th>
            <th class="itemcard-status">Status</th>
            <th class="itemcard-weight">Gewicht</th>
            <th class="itemcard-action-alone"></th>
          </tr>
        </thead>

        <tbody class="itemcard-tbody">
          {{ formset.non_form_errors }}

          {% for f in formset.forms %}
          <tr class="itemcard-table-row" data-kind="new" data-key="{{ f.prefix }}">
            <td class="checkbox-circle itemcard-action-left">
              <input type="checkbox"
                     name="selected_recycling"
                     value="new:{{ f.prefix }}"
                     title="Fraktion verknÃ¼pfen">
            </td>
            <td class="itemcard-id">{{ forloop.counter }}</td>
            <td class="itemcard-material">{{ f.material }}</td>
            <td class="itemcard-boxtype">{{ f.box_type }}</td>

            <td class="itemcard-status">
              {% if f.id %}{{ f.id }}{% endif %}
              {{ f.status }}
            </td>

            <td class="itemcard-weight itemcard-weight-action">
              <div class="flex-container">
                {{ f.weight }}
                <button type="button" class="btn btn-weight" title="Waage Ã¶ffnen">
                  <img src="{% static 'icons/dashboard-icon.svg' %}" alt="">
                </button>
              </div>
            </td>

            <td class="itemcard-action-wrapper">
              <div class="itemcard-action">
                <button type="button" class="btn btn-lock" aria-pressed="false" title="Zeile bearbeiten">
                  <img class="icon-lock-closed" src="{% static 'icons/lock-icon.svg' %}" alt="">
                  <img class="icon-lock-open"   src="{% static 'icons/lock-open-icon.svg' %}" alt="">
                </button>
                <button type="submit" class="btn btn-main btn-save">Speichern</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    {# ====== Aktive Wagen ====== #}
    <section>
      <div class="itemcard-table-title itemcard-margin-left">Aktive Wagen:</div>

      {{ existing_formset.management_form }}
      <table class="itemcard-table">
        <thead class="itemcard-thead">
          <tr>
            <th class="checkbox-circle itemcard-action-left"></th>
            <th class="itemcard-id">â„–</th>
            <th class="itemcard-material">Material</th>
            <th class="itemcard-boxtype">BehÃ¤lter</th>
            <th class="itemcard-status">Status</th>
            <th class="itemcard-weight">Gewicht</th>
            <th class="itemcard-action"></th>
          </tr>
        </thead>

        <tbody class="itemcard-tbody existing-tbody">
          {% if existing_formset.forms %}
            {% for form in existing_formset.forms %}
              <tr class="itemcard-table-row" data-kind="existing" data-key="{{ form.instance.pk }}">
                <td class="checkbox-circle itemcard-action-left">
                  <input type="checkbox"
                    name="selected_recycling"
                    value="{{ form.instance.pk }}"
                    title="Fraktion verknÃ¼pfen"
                    {% if form.instance.pk in linked_ids %}checked data-keep-enabled="true"{% endif %}>
                </td>

                <td class="itemcard-id">{{ forloop.counter }}</td>

                <td class="itemcard-material"><p>{{ form.instance.material }}</p></td>
                <td class="itemcard-boxtype"><p>{{ form.instance.get_box_type_display }}</p></td>

                <td class="itemcard-status">
                  {{ form.id }}
                  {{ form.status }}
                </td>

                <td class="itemcard-weight itemcard-weight-action">
                  <div class="flex-container">
                    {{ form.weight }}
                    <button type="button" class="btn btn-weight" title="Waage Ã¶ffnen">
                      <img src="{% static 'icons/dashboard-icon.svg' %}" alt="">
                    </button>
                  </div>
                </td>

                <td class="itemcard-action-wrapper">
                  <div class="itemcard-action">
                    <button type="button" class="btn btn-lock" aria-pressed="false" title="Zeile bearbeiten">
                      <img class="icon-lock-closed" src="{% static 'icons/lock-icon.svg' %}" alt="">
                      <img class="icon-lock-open"   src="{% static 'icons/lock-open-icon.svg' %}" alt="">
                    </button>
                    <button type="submit" class="btn btn-main btn-save">Speichern</button>
                  </div>
                </td>
              </tr>
            {% endfor %}

            {% else %}
            <tr class="itemcard-table-row">
              <td class="checkbox-circle itemcard-action-left">
                  <input type="checkbox" name="selected_recycling" title="Keine Daten">
                </td>
              <td colspan="5" class="text-center">
                Keine Daten vorhanden
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </section>
  </div>
</form>

<style>
  /* ===== Allgemeines Layout ===== */
  .flex-container { display: flex; align-items: center; gap: 0.5rem; }

  .btn-weight {
    padding: 0 5px;
    height: 26px;
    border: none;
    border-left: 1px solid #ccc;
    border-radius: 0;
    background: transparent;
  }

  .itemcard-weight-action input { border: none; outline: none; }

  .itemcard-action-wrapper { width: 114px; background: transparent; border: none; }

  /* ===== Sichtbarkeit: Speichern-Button nur in offener Zeile ===== */
  .itemcard-table-row .btn-save { display: none; }
  .itemcard-table-row.is-open .btn-save { display: inline-flex; }

  /* ===== Lock-Icon je nach Zustand ===== */
  .btn-lock .icon-lock-open { display: none; }
  .itemcard-table-row.is-open .btn-lock .icon-lock-closed { display: none; }
  .itemcard-table-row.is-open .btn-lock .icon-lock-open { display: inline; }

  /* ===== Interaktion sperren bei geschlossener Zeile ===== */
  .itemcard-table-row:not(.is-open) input,
  .itemcard-table-row:not(.is-open) select,
  .itemcard-table-row:not(.is-open) textarea,
  .itemcard-table-row:not(.is-open) button.btn-weight {
    pointer-events: none;
    opacity: 0.6;
  }
  .itemcard-table-row.is-open input,
  .itemcard-table-row.is-open select,
  .itemcard-table-row.is-open textarea,
  .itemcard-table-row.is-open button.btn-weight {
    pointer-events: auto;
    opacity: 1;
  }

  /* ðŸ‡©ðŸ‡ª Update-Sonderfall: verknÃ¼pfte Zeilen bleiben aktiv, obwohl der Lock zu ist */
  .itemcard-table-row[data-keep-enabled-row]:not(.is-open) input,
  .itemcard-table-row[data-keep-enabled-row]:not(.is-open) select,
  .itemcard-table-row[data-keep-enabled-row]:not(.is-open) textarea,
  .itemcard-table-row[data-keep-enabled-row]:not(.is-open) button.btn-weight {
    pointer-events: auto;
    opacity: 1;
  }

  .itemcard-table-row :disabled { cursor: not-allowed; }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/barcode-scan.js' %}"></script>
<script src="{% static 'js/close-open.js' %}"></script>
{% endblock %}
